
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Website and documentation for symplegma project">
      
      
        <meta name="author" content="Particule.">
      
      
        <link rel="canonical" href="https://particuleio.github.io/symplegma/user-guides/openstack/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.6">
    
    
      
        <title>OpenStack - Symplegma</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.9d5733d3.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploying-on-openstack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Symplegma" class="md-header__button md-logo" aria-label="Symplegma" data-md-component="logo">
      
  <img src="../../images/logo-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Symplegma
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OpenStack
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/particuleio/symplegma/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    particuleio/symplegma
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Symplegma" class="md-nav__button md-logo" aria-label="Symplegma" data-md-component="logo">
      
  <img src="../../images/logo-white.svg" alt="logo">

    </a>
    Symplegma
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/particuleio/symplegma/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    particuleio/symplegma
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/kubeadm/kubeadm/" class="md-nav__link">
        Kubeadm
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          OS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OS" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          OS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/os/ubuntu/" class="md-nav__link">
        Ubuntu
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/os/flatcar/" class="md-nav__link">
        Flatcar
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Networking
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Networking" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/networking/ha/" class="md-nav__link">
        HA
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          Container Runtimes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Container Runtimes" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Container Runtimes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/container_runtimes/crio/" class="md-nav__link">
        CRI-O
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/container_runtimes/containerd/" class="md-nav__link">
        Containerd
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          User Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          User Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bare-metal/" class="md-nav__link">
        Bare-Metal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        AWS
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          OpenStack
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        OpenStack
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-and-terragrunt" class="md-nav__link">
    Terraform and Terragrunt
  </a>
  
    <nav class="md-nav" aria-label="Terraform and Terragrunt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terragrunt-modules" class="md-nav__link">
    Terragrunt modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terragrunt-variables" class="md-nav__link">
    Terragrunt variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-infrastructure" class="md-nav__link">
    Creating the infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Creating the infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-infrastructure" class="md-nav__link">
    Customizing the infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-the-infrastructure" class="md-nav__link">
    Initializing the infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-kubernetes-with-symplegma-playbooks" class="md-nav__link">
    Deploying Kubernetes with symplegma playbooks
  </a>
  
    <nav class="md-nav" aria-label="Deploying Kubernetes with symplegma playbooks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openstack-dynamic-inventory" class="md-nav__link">
    OpenStack Dynamic inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-kubernetes-deployment" class="md-nav__link">
    Customizing Kubernetes deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-playbooks-with-deployment-script" class="md-nav__link">
    Running the playbooks with deployment script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-cluster-access" class="md-nav__link">
    Testing cluster access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-and-terragrunt" class="md-nav__link">
    Terraform and Terragrunt
  </a>
  
    <nav class="md-nav" aria-label="Terraform and Terragrunt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terragrunt-modules" class="md-nav__link">
    Terragrunt modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terragrunt-variables" class="md-nav__link">
    Terragrunt variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-infrastructure" class="md-nav__link">
    Creating the infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Creating the infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-infrastructure" class="md-nav__link">
    Customizing the infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-the-infrastructure" class="md-nav__link">
    Initializing the infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-kubernetes-with-symplegma-playbooks" class="md-nav__link">
    Deploying Kubernetes with symplegma playbooks
  </a>
  
    <nav class="md-nav" aria-label="Deploying Kubernetes with symplegma playbooks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openstack-dynamic-inventory" class="md-nav__link">
    OpenStack Dynamic inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-kubernetes-deployment" class="md-nav__link">
    Customizing Kubernetes deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-playbooks-with-deployment-script" class="md-nav__link">
    Running the playbooks with deployment script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-cluster-access" class="md-nav__link">
    Testing cluster access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/particuleio/symplegma/edit/master/docs/user-guides/openstack.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>



<h1 id="deploying-on-openstack">Deploying on OpenStack<a class="headerlink" href="#deploying-on-openstack" title="Permanent link">&para;</a></h1>
<p>Symplegma supports OpenStack as a cloud provider.</p>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h2>
<p>For now, each cluster should have its own OpenStack project. Modules used are from the <a href="https://github.com/kubernetes-incubator/kubepsray">Kubepsray project</a> and are included inside the symplegma module, this is subject to change in the future as PR are welcomed to make the possibilities evolved and split modules.</p>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.terraform.io/intro/getting-started/install.html">Terraform</a></li>
<li><a href="https://github.com/gruntwork-io/terragrunt#install-terragrunt">Terragrunt</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">Ansible</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a></li>
</ul>
<p>Git clone Symplegma main repository:</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/clusterfrak-dynamics/symplegma.git
</code></pre></div>
<p>Fetch the roles with <code>ansible-galaxy</code>:</p>
<div class="highlight"><pre><span></span><code>ansible-galaxy install -r requirements.yml
</code></pre></div>
<h2 id="terraform-and-terragrunt">Terraform and Terragrunt<a class="headerlink" href="#terraform-and-terragrunt" title="Permanent link">&para;</a></h2>
<p>Terragrunt is used to enable multiple cluster and environments.</p>
<h3 id="terragrunt-modules">Terragrunt modules<a class="headerlink" href="#terragrunt-modules" title="Permanent link">&para;</a></h3>
<p>Symplegma is packaged in a <a href="https://github.com/gruntwork-io/terragrunt">Terragrunt module</a> available <a href="https://github.com/clusterfrak-dynamics/symplegma/tree/master/contrib/openstack/terraform">here</a>.</p>
<h3 id="terragrunt-variables">Terragrunt variables<a class="headerlink" href="#terragrunt-variables" title="Permanent link">&para;</a></h3>
<p>Cluster specific variables:</p>
<div class="highlight"><pre><span></span><code>terragrunt = {
  include {
    path = &quot;${find_in_parent_folders()}&quot;
  }

  terraform {
    source = &quot;github.com/clusterfrak-dynamics/symplegma.git//contrib/openstack/terraform/modules/symplegma&quot;
  }
}

//
// [provider]
//

//
// [kubernetes]
//
cluster_name = &quot;symplegma&quot;

network_name    = &quot;internal_network&quot;
subnet_cidr     = &quot;10.0.0.0/24&quot;
dns_nameservers = []
use_neutron     = &quot;1&quot;

number_of_k8s_masters         = &quot;3&quot;
number_of_k8s_masters_no_etcd = &quot;0&quot;
number_of_k8s_nodes           = &quot;0&quot;
floatingip_pool               = &quot;ext-net&quot;
number_of_bastions            = &quot;0&quot;
external_net                  = &quot;ext-net-uuid&quot;
router_id                     = &quot;&quot;

az_list                                      = [&quot;nova&quot;]
number_of_etcd                               = &quot;0&quot;
number_of_k8s_masters_no_floating_ip         = &quot;0&quot;
number_of_k8s_masters_no_floating_ip_no_etcd = &quot;0&quot;
number_of_k8s_nodes_no_floating_ip           = &quot;0&quot;
public_key_path                              = &quot;~/.ssh/id_rsa.pub&quot;
image                                        = &quot;CoreOS 1068.9.0&quot;
ssh_user                                     = &quot;core&quot;
flavor_k8s_master                            = &quot;128829e3-117d-49da-ae58-981bb2c04b0e&quot;
flavor_k8s_node                              = &quot;128829e3-117d-49da-ae58-981bb2c04b0e&quot;
flavor_etcd                                  = &quot;128829e3-117d-49da-ae58-981bb2c04b0e&quot;
flavor_bastion                               = &quot;128829e3-117d-49da-ae58-981bb2c04b0e&quot;
k8s_master_fips                              = []
k8s_node_fips                                = []
bastion_fips                                 = []
bastion_allowed_remote_ips                   = [&quot;0.0.0.0/0&quot;]
supplementary_master_groups                  = &quot;&quot;
supplementary_node_groups                    = &quot;&quot;
worker_allowed_ports                         = [
  {
    &quot;protocol&quot; = &quot;tcp&quot;
    &quot;port_range_min&quot; = 30000
    &quot;port_range_max&quot; = 32767
    &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
  }
]
</code></pre></div>
<h2 id="creating-the-infrastructure">Creating the infrastructure<a class="headerlink" href="#creating-the-infrastructure" title="Permanent link">&para;</a></h2>
<p>To init a new OpenStack cluster, simply run <code>./scripts/init-openstack.sh $CLUSTER_NAME</code></p>
<p>It will generate <code>inventory/openstack/$CLUSTER_NAME</code> with the following directory structure:</p>
<div class="highlight"><pre><span></span><code>sample
├── openstack.py -&gt; ../../../contrib/openstack/inventory/openstack.py
├── extra_vars.yml
├── group_vars
│   └── all
│       └── all.yml
├── host_vars
├── symplegma-ansible.sh -&gt; ../../../contrib/openstack/scripts/symplegma-ansible.sh
└── tf_module_symplegma
    └── terraform.tfvars
</code></pre></div>
<h3 id="customizing-the-infrastructure">Customizing the infrastructure<a class="headerlink" href="#customizing-the-infrastructure" title="Permanent link">&para;</a></h3>
<p>Terraform variable files come with sensible default.</p>
<p>If you wish to change remote state configuration you can edit <code>$CLUSTER_NAME/terraform.tfvars</code></p>
<p>If you wish to customize the infrastructure you can edit <code>$CLUSTER_NAME/tf_module_symplegma/terraform.tfvars</code></p>
<p>One of the most important variable is <code>cluster_name</code> that allows you tu use OpenStack dynamic inventory with multiple cluster. We recommend this variables to be coherent throughout your files and equals to <code>$CLUSTER_NAME</code> defined earlier.</p>
<p>There is also a set of sensible default tags that you can customize such as <code>Environment</code> for example or add your own.</p>
<p>To avoid bloating the configuration files and unnecessary hard coded values, Terraform provider credentials are derived from your OpenStack SDK config. Make sure you are using the correct OpenStack credentials by setting your <code>OS_CLOUD</code> environment variable. <a href="https://docs.openstack.org/python-openstackclient/rocky/cli/man/openstack.html">[more infos]</a></p>
<h3 id="initializing-the-infrastructure">Initializing the infrastructure<a class="headerlink" href="#initializing-the-infrastructure" title="Permanent link">&para;</a></h3>
<p>Once everything is configured to your needs, just run:</p>
<div class="highlight"><pre><span></span><code>terragrunt apply-all --terragrunt-source-update
</code></pre></div>
<p>Couples minute later you should see your instances spawning in your Horizon dashboard.</p>
<h2 id="deploying-kubernetes-with-symplegma-playbooks">Deploying Kubernetes with symplegma playbooks<a class="headerlink" href="#deploying-kubernetes-with-symplegma-playbooks" title="Permanent link">&para;</a></h2>
<h3 id="openstack-dynamic-inventory">OpenStack Dynamic inventory<a class="headerlink" href="#openstack-dynamic-inventory" title="Permanent link">&para;</a></h3>
<p>OpenStack dynamic inventory allows you to target a specific set of instances depending on the <code>$CLUSTER_NAME</code> you set earlier. You can configure the behavior of dynamic inventory by setting the following <code>ENV</code>:</p>
<ul>
<li><code>export SYMPLEGMA_CLUSTER=$CLUSTER_NAME</code> : Target only instances belonging to this cluster.</li>
</ul>
<p>To test the behavior of the dynamic inventory just run:</p>
<div class="highlight"><pre><span></span><code>./inventory/openstack/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>/openstack.py --list
</code></pre></div>
<p>It should only return a specific subset of your instances.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>These variables can be exported automatically when using the deployment script, but they can still be set manually for testing / manual deployment purposes.</p>
</div>
<h3 id="customizing-kubernetes-deployment">Customizing Kubernetes deployment<a class="headerlink" href="#customizing-kubernetes-deployment" title="Permanent link">&para;</a></h3>
<p>In the cluster folder, it is possible to edit Ansible variables:</p>
<ul>
<li><code>group_vars/all/all.yml</code>: contains default Ansible variables.</li>
</ul>
<div class="highlight"><pre><span></span><code>---
bootstrap_python: <span class="nb">false</span>
<span class="c1"># Install portable python distribution that do not provide python (eg.</span>
<span class="c1"># coreos/flatcar):</span>
<span class="c1"># bootstrap_python: true</span>
<span class="c1"># ansible_python_interpreter: /opt/bin/python</span>

ansible_ssh_user: ubuntu

ansible_ssh_common_args: <span class="s1">&#39;-o StrictHostKeyChecking=no&#39;</span>
<span class="c1"># To use a bastion host between node and ansible use:</span>
<span class="c1"># ansible_ssh_common_args: &#39;-o StrictHostKeyChecking=no -o ProxyCommand=&quot;ssh -o StrictHostKeyChecking=no -W %h:%p -q ubuntu@{{ ansible_ssh_bastion_host }}&quot;&#39;</span>
<span class="c1"># ansible_ssh_bastion_host: __BASTION_IP__</span>

kubeadm_version: v1.24.1
kubernetes_version: v1.24.1
<span class="c1"># If deploying HA clusters, specify the loadbalancer IP or domain name and port</span>
<span class="c1"># in front of the control plane nodes:</span>
<span class="c1"># kubernetes_api_server_address: __LB_HOSTNAME__</span>
<span class="c1"># kubernetes_api_server_port: __LB_LISTENER_PORT__</span>

bin_dir: /usr/local/bin
<span class="c1"># Change default path for custom binary. On OS with immutable file system (eg.</span>
<span class="c1"># coreos/flatcar) use a writable path</span>
<span class="c1"># bin_dir: /opt/bin</span>

<span class="c1"># Customize API server</span>
kubeadm_api_server_extra_args: <span class="o">{}</span>
kubeadm_api_server_extra_volumes: <span class="o">{}</span>

<span class="c1"># Customize controller manager scheduler</span>
<span class="c1"># eg. to publish prometheus metrics on &quot;0.0.0.0&quot;:</span>
<span class="c1"># kubeadm_controller_manager_extra_args: |</span>
<span class="c1">#   address: 0.0.0.0</span>
kubeadm_controller_manager_extra_args: <span class="o">{}</span>
kubeadm_controller_manager_extra_volumes: <span class="o">{}</span>

<span class="c1"># Customize scheduler manager scheduler</span>
<span class="c1"># eg. to publish prometheus metrics on &quot;0.0.0.0&quot;:</span>
<span class="c1"># kubeadm_scheduler_extra_args: |</span>
<span class="c1">#   address: 0.0.0.0</span>
kubeadm_scheduler_extra_volumes: <span class="o">{}</span>
kubeadm_scheduler_extra_args: <span class="o">{}</span>

<span class="c1"># Customize Kubelet</span>
<span class="c1"># `kubeadm_kubelet_extra_args` is to be used as a last resort,</span>
<span class="c1"># `kubeadm_kubelet_component_config` configure kubelet wth native kubeadm API,</span>
<span class="c1"># please see</span>
<span class="c1"># https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/ for</span>
<span class="c1"># more information</span>
kubeadm_kubelet_component_config: <span class="o">{}</span>
kubeadm_kubelet_extra_args: <span class="o">{}</span>


<span class="c1"># Customize Kube Proxy configuration using native Kubeadm API</span>
<span class="c1"># eg. to publish prometheus metrics on &quot;0.0.0.0&quot;:</span>
<span class="c1"># kubeadm_kube_proxy_component_config: |</span>
<span class="c1">#   metricsBindAddress: 0.0.0.0</span>
kubeadm_kube_proxy_component_config: <span class="o">{}</span>

<span class="c1"># Additionnal subject alternative names for the API server</span>
<span class="c1"># eg. to add aditionnals domains:</span>
<span class="c1"># kubeadm_api_server_cert_extra_sans: |</span>
<span class="c1">#   - mydomain.example.com</span>
kubeadm_api_server_cert_extra_sans: <span class="o">{}</span>

kubeadm_cluster_name: symplegma

<span class="c1"># Do not label master nor taint (skip kubeadm phase)</span>
<span class="c1"># kubeadm_mark_control_plane: false</span>

<span class="c1"># Enable systemd cgroup for Kubelet and container runtime</span>
<span class="c1"># DO NOT CHANGE this on an existing cluster: Changing the cgroup driver of a</span>
<span class="c1"># Node that has joined a cluster is strongly not recommended. If the kubelet</span>
<span class="c1"># has created Pods using the semantics of one cgroup driver, changing the</span>
<span class="c1"># container runtime to another cgroup driver can cause errors when trying to</span>
<span class="c1"># re-create the Pod sandbox for such existing Pods. Restarting the kubelet may</span>
<span class="c1"># not solve such errors. Default is to use cgroupfs.</span>
<span class="c1"># systemd_cgroup: true</span>

container_runtime: containerd
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>ansible_ssh_bastion_host</code>, <code>kubernetes_api_server_address</code> and <code>kubernetes_api_server_port</code> can be automatically populated when using the deployment script but they can still be set manually for testing / manual deployment purposes.</p>
</div>
<ul>
<li><code>extra_vars</code>: contains OpenStack cloud provider specific variables that you can override.</li>
</ul>
<div class="highlight"><pre><span></span><code>---
kubeadm_api_server_extra_args: <span class="p">|</span>
  cloud-provider: <span class="s2">&quot;openstack&quot;</span>

kubeadm_controller_manager_extra_args: <span class="p">|</span>-
    cloud-provider: <span class="s2">&quot;openstack&quot;</span>
    configure-cloud-routes: <span class="s2">&quot;false&quot;</span>

kubeadm_scheduler_extra_args: <span class="o">{}</span>
kubeadm_api_server_extra_volumes: <span class="o">{}</span>
kubeadm_controller_manager_extra_volumes: <span class="o">{}</span>
kubeadm_scheduler_extra_volumes: <span class="o">{}</span>
kubeadm_kubelet_extra_args: <span class="p">|</span>
  cloud-provider: <span class="s2">&quot;openstack&quot;</span>

calico_mtu: <span class="m">1430</span>
calico_ipv4pool_ipip: <span class="s2">&quot;Always&quot;</span>
calico_felix_ipip: <span class="s2">&quot;true&quot;</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you need to override control plane or kubelet specific parameters do it in <code>extra_vars.yml</code> as it overrides all other variables previously defined as per <a href="https://docs.ansible.com/ansible/2.7/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">Ansible variables precedence documentantion</a></p>
</div>
<h3 id="running-the-playbooks-with-deployment-script">Running the playbooks with deployment script<a class="headerlink" href="#running-the-playbooks-with-deployment-script" title="Permanent link">&para;</a></h3>
<p>A simple (really, it cannot be simpler) deployment script can call Ansible and compute the necessary Terraform output for you:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#! /bin/sh</span>

<span class="nv">INVENTORY_DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="si">${</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="nb">export</span> <span class="nv">SYMPLEGMA_CLUSTER</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all cluster_name <span class="m">2</span>&gt;/dev/null <span class="k">)</span><span class="s2">&quot;</span>

ansible-playbook -i <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/hosts.ini symplegma-init.yml -b -v <span class="se">\</span>
  -e @<span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/extra_vars.yml <span class="se">\</span>
  -e <span class="nv">ansible_ssh_bastion_host</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all bastion_fips <span class="m">2</span>&gt;/dev/null <span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
  <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>
<p>From the root of the repository just run your cluster deployment script:</p>
<div class="highlight"><pre><span></span><code>./inventory/openstack/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>/symplegma-ansible.sh
</code></pre></div>
<h3 id="testing-cluster-access">Testing cluster access<a class="headerlink" href="#testing-cluster-access" title="Permanent link">&para;</a></h3>
<p>When the deployment is over, <code>admin.conf</code> should be exported in <code>kubeconfig/$CLUSTER_NAME/admin.conf</code>. You should be able to call the Kubernetes API with <code>kubectl</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/kubeconfig/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>/admin.conf

kubectl get nodes

NAME                                       STATUS   ROLES    AGE     VERSION
ip-10-0-1-140.eu-west-1.compute.internal   Ready    &lt;none&gt;   2d22h   v1.13.0
ip-10-0-1-22.eu-west-1.compute.internal    Ready    master   2d22h   v1.13.0
ip-10-0-2-47.eu-west-1.compute.internal    Ready    &lt;none&gt;   2d22h   v1.13.0
ip-10-0-2-8.eu-west-1.compute.internal     Ready    master   2d22h   v1.13.0
ip-10-0-3-123.eu-west-1.compute.internal   Ready    master   2d22h   v1.13.0
</code></pre></div>
<p>EOD</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../aws/" class="md-footer__link md-footer__link--prev" aria-label="Previous: AWS" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              AWS
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs", "instant"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.5e67fbfe.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.e87a5f81.min.js"></script>
      
    
  </body>
</html>